"""
Functions for interfacing with Lena2
"""

from collections import OrderedDict
import pandas as pd
import requests
from StringIO import StringIO

import tenxpy.utils as tx_utils

LENA2_URL = 'http://lena2'

def get_sample_set(ss, product):
    """Retrieve Lena IDs for a given Lena2 Sample Set ID.
    Args:
      ss (str) - sample set id number
      product (str) - marsoc product e.g. "cellranger-dev"
    Returns:
      list of int"""
    r = requests.get(LENA2_URL + '/api/sample_set_csv/%s/%s' % (str(ss), product))
    df = pd.read_csv(StringIO(r.text))
    return list(df.Sample)

def make_aggr_csv(lena_ids, pipeline='SC_RNA_COUNTER_PD', version='HEAD', run_number=0):
    library_ids = map(lambda sid: '%s - %s' % (sid,
                                               tx_utils.get_sample_description(sid)),
                      lena_ids)
    molecule_h5s = map(lambda sid: tx_utils.get_out_file(sid, 'molecule_info.h5',
                                                         pipeline=pipeline,
                                                         version=version,
                                                         run_number=run_number), lena_ids)
    df = pd.DataFrame(OrderedDict([
        ('library_id', library_ids),
        ('molecule_h5', molecule_h5s),
    ]))
    return df.to_csv(None, index=False)
