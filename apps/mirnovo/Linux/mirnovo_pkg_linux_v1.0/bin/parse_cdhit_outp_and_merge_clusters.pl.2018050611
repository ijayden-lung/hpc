#!/usr/bin/env perl

use warnings;

my $base_dir = $ARGV[0];
my $cdhit_res = $base_dir."/consensus_sequences.fa.cdhit.clstr";

my $clusters_dir = $base_dir."/usearch_out";

my $merged_clusters_log_file = $base_dir."/merged_consensus_sequences.log";
open(OUT, ">$merged_clusters_log_file");


#>Cluster 71
#0       25nt, >cons_seqs_cluster.109... at +/96.00%
#1       26nt, >cons_seqs_cluster.147... *
#>Cluster 72
#0       26nt, >cons_seqs_cluster.140... *

open(FH, $cdhit_res);

# global variables
my $new_clusters_id = 0;
my $new_cluster_name = '';
my @tmp_similar_clusters = ();

my $line_cnt = 0;

while(<FH>){

    if($line_cnt == 0){
    	$line_cnt++;
	next;
    }

    chomp;

    if($_ =~ /^>/){

	update_clusters();
	
	$new_clusters_id++;
	# reset array
	@tmp_similar_clusters = ();
    } else{
    
#    	print "$_\n";
    	#0       25nt, >cons_seqs_cluster.109... at +/96.00%
	my @vals = split /\s+/, $_;
	my $cur_clust = $vals[2];

	$cur_clust =~ s/>cons_seqs_cluster\.//;
	$cur_clust =~ s/\.\.\.$//;

#	print "cur_clust: $cur_clust\n";
	push(@tmp_similar_clusters, $cur_clust);
    
    }
}

update_clusters();

close(FH);




sub update_clusters {
	$new_cluster_name = "$clusters_dir/ref_alignm.$new_clusters_id";
	print "new cluster name: $new_cluster_name\n";

	if($#tmp_similar_clusters > 0){
		#print("merging previously parsed similar clusters\n");

		#print join(", ", @tmp_similar_clusters)."\n";
		my $cl_to_merge = '';
		foreach(@tmp_similar_clusters){
			#$cl_to_merge .= "$clusters_dir/alignm.$_ ";
			$cl_to_merge = "$clusters_dir/alignm.$_";

			`cat $cl_to_merge >> $new_cluster_name`;
	    	}
		
		#`cat $cl_to_merge > $new_cluster_name`;

# keep alignm. files for calculating their features in the end of the analysis after splitting seqs into paralogw
#		foreach(@tmp_similar_clusters){
#		    `rm $clusters_dir/alignm.$_`;
#		}

		# save info for merged clusters into log file
		print OUT "$new_clusters_id\t".join(",", @tmp_similar_clusters)."\n";	

	} else{
		#print("singleton cluster..\n");
		my $prev_clust_file = "$clusters_dir/alignm.$tmp_similar_clusters[0]";
		
		#print "prev_clust_file: $prev_clust_file\n";
		`mv $prev_clust_file $new_cluster_name`;
	}	
}



