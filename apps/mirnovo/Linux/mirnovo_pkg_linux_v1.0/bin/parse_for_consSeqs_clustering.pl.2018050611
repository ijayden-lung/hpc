#!/usr/bin/env perl


use strict;
use warnings;

my $aln_id_thres = 85; 

my $cnt = 0;
my $clusters_to_merge = '';

while (<>) {
    # aln-aln={|||||xx|x||||||||||||} aln-r={TGAGAACAGTTTGAAAGCTGA} aln-q={TGAGATAATTTTGAAAGCTGA} r-start=1 q-start=1 aln-id=86 r-annot={cons_seqs_cluster.3581} q-annot={cons_seqs_cluster.972}


   /aln-aln={(.*?)} aln-r={(.*?)} aln-q={(.*?)} r-start=(.*?) q-start=(.*?).*aln-id=(.*?) r-annot={(.*?)} q-annot={(.*?)}/ || die "huh";
   my ($aln_map, $aln_r, $aln_q, $ref, $query, $aln_id, $id1, $id2) = ($1, $2, $3, $4, $5, $6, $7, $8);
   my $nmatch = ($aln_map =~ tr /\|/\|/);


   $aln_q =~ s/-//g;
   $aln_r =~ s/-//g;

   my $nedit = length($aln_map) - $nmatch;
   my $noverhang_q = length($query) - length($aln_q);
   my $noverhang_r = length($ref) - length($aln_r);
   my $edit_dist = $nedit + $noverhang_r + $noverhang_q;
   # print "$nedit\t$noverhang_r\t$noverhang_q\t$edit_dist\n";

       ##   I've picked 25 based on a histogram of edit distances.
       ##   It's where a sharp drop-off happens; the mass majority of
       ##   distances is in the range [0,25].

   my $similarity = 25 - $edit_dist;
   #print "$id1\t$id2\t$similarity\n" if $similarity > 0;
   #print "$id1\t$id2\t1\n" unless $nedit;
   
   if($aln_id >= $aln_id_thres){
       #print "$id1\t$id2\t1\n";
       my $id1_num = substr($id1, index($id1, "\.")+1);
       my $id2_num = substr($id2, index($id2, "\.")+1);

       $aln_id /= 100;

       print "$id1_num\t$id2_num\t$aln_id\n";
#        if($clusters_to_merge eq ''){
#            $clusters_to_merge = $id2_num;
#        } else{
#            $clusters_to_merge .= ",$id2_num";
#        }

   }
}

#print $clusters_to_merge;

__DATA__
