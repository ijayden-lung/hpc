#!/usr/bin/env perl

use strict;
use warnings;

my $base_dir = $ARGV[0];
my $job_id = $ARGV[1];
my $cdhit_aln_id = $ARGV[2];
my $cdhit_kmer = $ARGV[3];

$cdhit_kmer = 10;
if($cdhit_aln_id > 0.90 && $cdhit_aln_id <= 0.95){
	$cdhit_kmer = 8;
} elsif($cdhit_aln_id > 0.88 && $cdhit_aln_id <= 0.90){
	$cdhit_kmer = 7;
} elsif($cdhit_aln_id > 0.85 && $cdhit_aln_id <= 0.88){
	$cdhit_kmer = 6;
} elsif($cdhit_aln_id > 0.8 && $cdhit_aln_id <= 0.85){
	$cdhit_kmer = 5;
} elsif($cdhit_aln_id >= 0.75 && $cdhit_aln_id <= 0.80){
	$cdhit_kmer = 4;
}

print "[$job_id]>> Refining vsearch-derived clusters...\n";

my $cons_file = $base_dir."/consensus_sequences.fa";
my %checked_clusters;

#my $cdhit_aln_id = 0.85; # maybe set it to 0.80 eventually
#my $cdhit_kmer = 5;


`./util/cd-hit-est -i $cons_file -o $cons_file.cdhit  -c $cdhit_aln_id -n $cdhit_kmer -d 0 -M 0 -T 0`;
print "./util/cd-hit-est -i $cons_file -o $cons_file.cdhit  -c $cdhit_aln_id -n $cdhit_kmer -d 0 -M 0 -T 0\n";

# dbg:
#print "perl parse_cdhit_outp_and_merge_clusters.pl $base_dir\n";
# parse ch-dit output
`perl parse_cdhit_outp_and_merge_clusters.pl $base_dir`;



print "[$job_id]<< Clusters refinement complete!\n\n";
